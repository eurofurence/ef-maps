"use strict";var pmtiles=(()=>{var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__async=(__this,__arguments,generator)=>new Promise(((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())})),js_exports={};((target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})})(js_exports,{Compression:()=>Compression,EtagMismatch:()=>EtagMismatch,FetchSource:()=>FetchSource,FileAPISource:()=>FileAPISource,PMTiles:()=>PMTiles,Protocol:()=>Protocol,ResolvedValueCache:()=>ResolvedValueCache,SharedPromiseCache:()=>SharedPromiseCache,TileType:()=>TileType,bytesToHeader:()=>bytesToHeader,findTile:()=>findTile,getUint64:()=>getUint64,leafletRasterLayer:()=>leafletRasterLayer,readVarint:()=>readVarint,tileIdToZxy:()=>tileIdToZxy,zxyToTileId:()=>zxyToTileId});var u8=Uint8Array,u16=Uint16Array,i32=Int32Array,fleb=new u8([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fdeb=new u8([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),clim=new u8([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),freb=function(eb,start){for(var b=new u16(31),i=0;i<31;++i)b[i]=start+=1<<eb[i-1];var r=new i32(b[30]);for(i=1;i<30;++i)for(var j=b[i];j<b[i+1];++j)r[j]=j-b[i]<<5|i;return{b:b,r:r}},_a=freb(fleb,2),fl=_a.b,revfl=_a.r;fl[28]=258,revfl[258]=28;var x,_b=freb(fdeb,0),fd=_b.b,rev=(_b.r,new u16(32768));for(i=0;i<32768;++i)x=(61680&(x=(52428&(x=(43690&i)>>1|(21845&i)<<1))>>2|(13107&x)<<2))>>4|(3855&x)<<4,rev[i]=((65280&x)>>8|(255&x)<<8)>>1;var hMap=function(cd,mb,r){for(var s=cd.length,i=0,l=new u16(mb);i<s;++i)cd[i]&&++l[cd[i]-1];var co,le=new u16(mb);for(i=1;i<mb;++i)le[i]=le[i-1]+l[i-1]<<1;if(r){co=new u16(1<<mb);var rvb=15-mb;for(i=0;i<s;++i)if(cd[i])for(var sv=i<<4|cd[i],r_1=mb-cd[i],v=le[cd[i]-1]++<<r_1,m=v|(1<<r_1)-1;v<=m;++v)co[rev[v]>>rvb]=sv}else for(co=new u16(s),i=0;i<s;++i)cd[i]&&(co[i]=rev[le[cd[i]-1]++]>>15-cd[i]);return co},flt=new u8(288);for(i=0;i<144;++i)flt[i]=8;for(i=144;i<256;++i)flt[i]=9;for(i=256;i<280;++i)flt[i]=7;for(i=280;i<288;++i)flt[i]=8;var i,fdt=new u8(32);for(i=0;i<32;++i)fdt[i]=5;var flrm=hMap(flt,9,1),fdrm=hMap(fdt,5,1),max=function(a){for(var m=a[0],i=1;i<a.length;++i)a[i]>m&&(m=a[i]);return m},bits=function(d,p,m){var o=p/8|0;return(d[o]|d[o+1]<<8)>>(7&p)&m},bits16=function(d,p){var o=p/8|0;return(d[o]|d[o+1]<<8|d[o+2]<<16)>>(7&p)},ec=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],err=function(ind,msg,nt){var e=new Error(msg||ec[ind]);if(e.code=ind,Error.captureStackTrace&&Error.captureStackTrace(e,err),!nt)throw e;return e},inflt=function(dat,st,buf,dict){var sl=dat.length,dl=dict?dict.length:0;if(!sl||st.f&&!st.l)return buf||new u8(0);var noBuf=!buf||2!=st.i,noSt=st.i;buf||(buf=new u8(3*sl));var cbuf=function(l2){var bl=buf.length;if(l2>bl){var nbuf=new u8(Math.max(2*bl,l2));nbuf.set(buf),buf=nbuf}},final=st.f||0,pos=st.p||0,bt=st.b||0,lm=st.l,dm=st.d,lbt=st.m,dbt=st.n,tbts=8*sl;do{if(!lm){final=bits(dat,pos,1);var type=bits(dat,pos+1,3);if(pos+=3,!type){var l=dat[(s=4+((pos+7)/8|0))-4]|dat[s-3]<<8,t=s+l;if(t>sl){noSt&&err(0);break}noBuf&&cbuf(bt+l),buf.set(dat.subarray(s,t),bt),st.b=bt+=l,st.p=pos=8*t,st.f=final;continue}if(1==type)lm=flrm,dm=fdrm,lbt=9,dbt=5;else if(2==type){var hLit=bits(dat,pos,31)+257,hcLen=bits(dat,pos+10,15)+4,tl=hLit+bits(dat,pos+5,31)+1;pos+=14;for(var ldt=new u8(tl),clt=new u8(19),i=0;i<hcLen;++i)clt[clim[i]]=bits(dat,pos+3*i,7);pos+=3*hcLen;var clb=max(clt),clbmsk=(1<<clb)-1,clm=hMap(clt,clb,1);for(i=0;i<tl;){var s,r=clm[bits(dat,pos,clbmsk)];if(pos+=15&r,(s=r>>4)<16)ldt[i++]=s;else{var c=0,n=0;for(16==s?(n=3+bits(dat,pos,3),pos+=2,c=ldt[i-1]):17==s?(n=3+bits(dat,pos,7),pos+=3):18==s&&(n=11+bits(dat,pos,127),pos+=7);n--;)ldt[i++]=c}}var lt=ldt.subarray(0,hLit),dt=ldt.subarray(hLit);lbt=max(lt),dbt=max(dt),lm=hMap(lt,lbt,1),dm=hMap(dt,dbt,1)}else err(1);if(pos>tbts){noSt&&err(0);break}}noBuf&&cbuf(bt+131072);for(var lms=(1<<lbt)-1,dms=(1<<dbt)-1,lpos=pos;;lpos=pos){var sym=(c=lm[bits16(dat,pos)&lms])>>4;if((pos+=15&c)>tbts){noSt&&err(0);break}if(c||err(2),sym<256)buf[bt++]=sym;else{if(256==sym){lpos=pos,lm=null;break}var add=sym-254;if(sym>264){var b=fleb[i=sym-257];add=bits(dat,pos,(1<<b)-1)+fl[i],pos+=b}var d=dm[bits16(dat,pos)&dms],dsym=d>>4;d||err(3),pos+=15&d;dt=fd[dsym];if(dsym>3){b=fdeb[dsym];dt+=bits16(dat,pos)&(1<<b)-1,pos+=b}if(pos>tbts){noSt&&err(0);break}noBuf&&cbuf(bt+131072);var end=bt+add;if(bt<dt){var shift2=dl-dt,dend=Math.min(dt,end);for(shift2+bt<0&&err(3);bt<dend;++bt)buf[bt]=dict[shift2+bt]}for(;bt<end;bt+=4)buf[bt]=buf[bt-dt],buf[bt+1]=buf[bt+1-dt],buf[bt+2]=buf[bt+2-dt],buf[bt+3]=buf[bt+3-dt];bt=end}}st.l=lm,st.p=lpos,st.b=bt,st.f=final,lm&&(final=1,st.m=lbt,st.d=dm,st.n=dbt)}while(!final);return bt==buf.length?buf:function(v,s,e){(null==s||s<0)&&(s=0),(null==e||e>v.length)&&(e=v.length);var n=new u8(e-s);return n.set(v.subarray(s,e)),n}(buf,0,bt)},et=new u8(0),gzs=function(d){31==d[0]&&139==d[1]&&8==d[2]||err(6,"invalid gzip data");var flg=d[3],st=10;4&flg&&(st+=2+(d[10]|d[11]<<8));for(var zs=(flg>>3&1)+(flg>>4&1);zs>0;zs-=!d[st++]);return st+(2&flg)},gzl=function(d){var l=d.length;return(d[l-4]|d[l-3]<<8|d[l-2]<<16|d[l-1]<<24)>>>0},zls=function(d,dict){return(8!=(15&d[0])||d[0]>>4>7||(d[0]<<8|d[1])%31)&&err(6,"invalid zlib data"),(d[1]>>5&1)==+!dict&&err(6,"invalid zlib data: "+(32&d[1]?"need":"unexpected")+" dictionary"),2+(d[1]>>3&4)};function decompressSync(data,opts){return 31==data[0]&&139==data[1]&&8==data[2]?function(data,opts){var st=gzs(data);return st+8>data.length&&err(6,"invalid gzip data"),inflt(data.subarray(st,-8),{i:2},opts&&opts.out||new u8(gzl(data)),opts&&opts.dictionary)}(data,opts):8!=(15&data[0])||data[0]>>4>7||(data[0]<<8|data[1])%31?function(data,opts){return inflt(data,{i:2},opts&&opts.out,opts&&opts.dictionary)}(data,opts):function(data,opts){return inflt(data.subarray(zls(data,opts&&opts.dictionary),-4),{i:2},opts&&opts.out,opts&&opts.dictionary)}(data,opts)}var td="undefined"!=typeof TextDecoder&&new TextDecoder;try{td.decode(et,{stream:!0}),1}catch(e){}var shift=(n,shift2)=>n*Math.pow(2,shift2),unshift=(n,shift2)=>Math.floor(n/Math.pow(2,shift2)),getUint24=(view,pos)=>shift(view.getUint16(pos+1,!0),8)+view.getUint8(pos),getUint48=(view,pos)=>shift(view.getUint32(pos+2,!0),16)+view.getUint16(pos,!0),compare=(tz,tx,ty,view,i)=>{if(tz!=view.getUint8(i))return tz-view.getUint8(i);const x=getUint24(view,i+1);if(tx!=x)return tx-x;const y=getUint24(view,i+4);return ty!=y?ty-y:0},queryTile=(view,z,x,y)=>{const offset_len=queryView(view,z,x,y);return offset_len?{z:z,x:x,y:y,offset:offset_len[0],length:offset_len[1],is_dir:!1}:null},queryView=(view,z,x,y)=>{let m=0,n=view.byteLength/17-1;for(;m<=n;){const k=n+m>>1,cmp=compare(z,x,y,view,17*k);if(cmp>0)m=k+1;else{if(!(cmp<0))return[getUint48(view,17*k+7),view.getUint32(17*k+13,!0)];n=k-1}}return null},entrySort=(a,b)=>a.is_dir&&!b.is_dir?1:!a.is_dir&&b.is_dir?-1:a.z!==b.z?a.z-b.z:a.x!==b.x?a.x-b.x:a.y-b.y,parseEntry=(dataview,i)=>{const z_raw=dataview.getUint8(17*i);return{z:127&z_raw,x:getUint24(dataview,17*i+1),y:getUint24(dataview,17*i+4),offset:getUint48(dataview,17*i+7),length:dataview.getUint32(17*i+13,!0),is_dir:z_raw>>7==1}},sortDir=a=>{const entries=[],view=new DataView(a);for(let i=0;i<view.byteLength/17;i++)entries.push(parseEntry(view,i));return createDirectory(entries)},createDirectory=entries=>{entries.sort(entrySort);const buffer=new ArrayBuffer(17*entries.length),arr=new Uint8Array(buffer);for(let i=0;i<entries.length;i++){const entry=entries[i];let z=entry.z;entry.is_dir&&(z|=128),arr[17*i]=z,arr[17*i+1]=255&entry.x,arr[17*i+2]=entry.x>>8&255,arr[17*i+3]=entry.x>>16&255,arr[17*i+4]=255&entry.y,arr[17*i+5]=entry.y>>8&255,arr[17*i+6]=entry.y>>16&255,arr[17*i+7]=255&entry.offset,arr[17*i+8]=255&unshift(entry.offset,8),arr[17*i+9]=255&unshift(entry.offset,16),arr[17*i+10]=255&unshift(entry.offset,24),arr[17*i+11]=255&unshift(entry.offset,32),arr[17*i+12]=255&unshift(entry.offset,48),arr[17*i+13]=255&entry.length,arr[17*i+14]=entry.length>>8&255,arr[17*i+15]=entry.length>>16&255,arr[17*i+16]=entry.length>>24&255}return buffer};var v2_default={getHeader:function(source){return __async(this,null,(function*(){const resp=yield source.getBytes(0,512e3),dataview=new DataView(resp.data),json_size=dataview.getUint32(4,!0),root_entries=dataview.getUint16(8,!0),dec=new TextDecoder("utf-8"),json_metadata=JSON.parse(dec.decode(new DataView(resp.data,10,json_size)));let tile_compression=0;"gzip"===json_metadata.compression&&(tile_compression=2);let minzoom=0;"minzoom"in json_metadata&&(minzoom=+json_metadata.minzoom);let maxzoom=0;"maxzoom"in json_metadata&&(maxzoom=+json_metadata.maxzoom);let center_lon=0,center_lat=0,center_zoom=0,min_lon=-180,min_lat=-85,max_lon=180,max_lat=85;if(json_metadata.bounds){const split=json_metadata.bounds.split(",");min_lon=+split[0],min_lat=+split[1],max_lon=+split[2],max_lat=+split[3]}if(json_metadata.center){const split=json_metadata.center.split(",");center_lon=+split[0],center_lat=+split[1],center_zoom=+split[2]}return{specVersion:dataview.getUint16(2,!0),rootDirectoryOffset:10+json_size,rootDirectoryLength:17*root_entries,jsonMetadataOffset:10,jsonMetadataLength:json_size,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:tile_compression,tileType:1,minZoom:minzoom,maxZoom:maxzoom,minLon:min_lon,minLat:min_lat,maxLon:max_lon,maxLat:max_lat,centerZoom:center_zoom,centerLon:center_lon,centerLat:center_lat,etag:resp.etag}}))},getZxy:function(header,source,cache,z,x,y,signal){return __async(this,null,(function*(){let root_dir=yield cache.getArrayBuffer(source,header.rootDirectoryOffset,header.rootDirectoryLength,header);1===header.specVersion&&(root_dir=sortDir(root_dir));const entry=queryTile(new DataView(root_dir),z,x,y);if(entry){let tile_data=(yield source.getBytes(entry.offset,entry.length,signal)).data;const view=new DataView(tile_data);return 31==view.getUint8(0)&&139==view.getUint8(1)&&(tile_data=decompressSync(new Uint8Array(tile_data))),{data:tile_data}}const leafcoords=((view,tile)=>{if(view.byteLength<17)return null;const numEntries=view.byteLength/17,entry=parseEntry(view,numEntries-1);if(entry.is_dir){const leaf_level=entry.z,level_diff=tile.z-leaf_level;return{z:leaf_level,x:Math.trunc(tile.x/(1<<level_diff)),y:Math.trunc(tile.y/(1<<level_diff))}}return null})(new DataView(root_dir),{z:z,x:x,y:y});if(leafcoords){const leafdir_entry=((view,z,x,y)=>{const offset_len=queryView(view,128|z,x,y);return offset_len?{z:z,x:x,y:y,offset:offset_len[0],length:offset_len[1],is_dir:!0}:null})(new DataView(root_dir),leafcoords.z,leafcoords.x,leafcoords.y);if(leafdir_entry){let leaf_dir=yield cache.getArrayBuffer(source,leafdir_entry.offset,leafdir_entry.length,header);1===header.specVersion&&(leaf_dir=sortDir(leaf_dir));const tile_entry=queryTile(new DataView(leaf_dir),z,x,y);if(tile_entry){let tile_data=(yield source.getBytes(tile_entry.offset,tile_entry.length,signal)).data;const view=new DataView(tile_data);return 31==view.getUint8(0)&&139==view.getUint8(1)&&(tile_data=decompressSync(new Uint8Array(tile_data))),{data:tile_data}}}}}))}},leafletRasterLayer=(source,options)=>{let loaded=!1,mimeType="";return new(L.GridLayer.extend({createTile:function(coord,done){const el=document.createElement("img"),controller=new AbortController,signal=controller.signal;return el.cancel=()=>{controller.abort()},loaded||(source.getHeader().then((header=>{1==header.tileType?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):2==header.tileType?mimeType="image/png":3==header.tileType?mimeType="image/jpeg":4==header.tileType?mimeType="image/webp":5==header.tileType&&(mimeType="image/avif")})),loaded=!0),source.getZxy(coord.z,coord.x,coord.y,signal).then((arr=>{if(arr){const blob=new Blob([arr.data],{type:mimeType}),imageUrl=window.URL.createObjectURL(blob);el.src=imageUrl,el.cancel=null,done(null,el)}})).catch((e=>{if("AbortError"!==e.name)throw e})),el},_removeTile:function(key){const tile=this._tiles[key];tile&&(tile.el.cancel&&tile.el.cancel(),tile.el.width=0,tile.el.height=0,tile.el.deleted=!0,L.DomUtil.remove(tile.el),delete this._tiles[key],this.fire("tileunload",{tile:tile.el,coords:this._keyToTileCoords(key)}))}}))(options)},Protocol=class{constructor(){this.tile=(params,callback)=>{if("json"==params.type){const pmtiles_url=params.url.substr(10);let instance=this.tiles.get(pmtiles_url);return instance||(instance=new PMTiles(pmtiles_url),this.tiles.set(pmtiles_url,instance)),instance.getHeader().then((h=>{const tilejson={tiles:[params.url+"/{z}/{x}/{y}"],minzoom:h.minZoom,maxzoom:h.maxZoom,bounds:[h.minLon,h.minLat,h.maxLon,h.maxLat]};callback(null,tilejson,null,null)})).catch((e=>{callback(e,null,null,null)})),{cancel:()=>{}}}{const re=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),result=params.url.match(re);if(!result)throw new Error("Invalid PMTiles protocol URL");const pmtiles_url=result[1];let instance=this.tiles.get(pmtiles_url);instance||(instance=new PMTiles(pmtiles_url),this.tiles.set(pmtiles_url,instance));const z=result[2],x=result[3],y=result[4],controller=new AbortController,signal=controller.signal;let cancel=()=>{controller.abort()};return instance.getHeader().then((header=>{instance.getZxy(+z,+x,+y,signal).then((resp=>{resp?callback(null,new Uint8Array(resp.data),resp.cacheControl,resp.expires):1==header.tileType?callback(null,new Uint8Array,null,null):callback(null,null,null,null)})).catch((e=>{"AbortError"!==e.name&&callback(e,null,null,null)}))})),{cancel:cancel}}},this.tiles=new Map}add(p){this.tiles.set(p.source.getKey(),p)}get(url){return this.tiles.get(url)}};function toNum(low,high){return 4294967296*(high>>>0)+(low>>>0)}function readVarint(p){const buf=p.buf;let val,b;return b=buf[p.pos++],val=127&b,b<128?val:(b=buf[p.pos++],val|=(127&b)<<7,b<128?val:(b=buf[p.pos++],val|=(127&b)<<14,b<128?val:(b=buf[p.pos++],val|=(127&b)<<21,b<128?val:(b=buf[p.pos],val|=(15&b)<<28,function(l,p){const buf=p.buf;let h,b;if(b=buf[p.pos++],h=(112&b)>>4,b<128)return toNum(l,h);if(b=buf[p.pos++],h|=(127&b)<<3,b<128)return toNum(l,h);if(b=buf[p.pos++],h|=(127&b)<<10,b<128)return toNum(l,h);if(b=buf[p.pos++],h|=(127&b)<<17,b<128)return toNum(l,h);if(b=buf[p.pos++],h|=(127&b)<<24,b<128)return toNum(l,h);if(b=buf[p.pos++],h|=(1&b)<<31,b<128)return toNum(l,h);throw new Error("Expected varint not more than 10 bytes")}(val,p)))))}function rotate(n,xy,rx,ry){if(0==ry){1==rx&&(xy[0]=n-1-xy[0],xy[1]=n-1-xy[1]);const t=xy[0];xy[0]=xy[1],xy[1]=t}}function idOnLevel(z,pos){const n=Math.pow(2,z);let rx=pos,ry=pos,t=pos;const xy=[0,0];let s=1;for(;s<n;)rx=1&t/2,ry=1&(t^rx),rotate(s,xy,rx,ry),xy[0]+=s*rx,xy[1]+=s*ry,t/=4,s*=2;return[z,xy[0],xy[1]]}var tzValues=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function zxyToTileId(z,x,y){if(z>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(x>Math.pow(2,z)-1||y>Math.pow(2,z)-1)throw Error("tile x/y outside zoom level bounds");const acc=tzValues[z];let rx=0,ry=0,d=0;const xy=[x,y];let s=Math.pow(2,z)/2;for(;s>0;)rx=(xy[0]&s)>0?1:0,ry=(xy[1]&s)>0?1:0,d+=s*s*(3*rx^ry),rotate(s,xy,rx,ry),s/=2;return acc+d}function tileIdToZxy(i){let acc=0;for(let z2=0;z2<27;z2++){const num_tiles=(1<<z2)*(1<<z2);if(acc+num_tiles>i)return idOnLevel(z2,i-acc);acc+=num_tiles}throw Error("Tile zoom level exceeds max safe number limit (26)")}var Compression=(Compression2=>(Compression2[Compression2.Unknown=0]="Unknown",Compression2[Compression2.None=1]="None",Compression2[Compression2.Gzip=2]="Gzip",Compression2[Compression2.Brotli=3]="Brotli",Compression2[Compression2.Zstd=4]="Zstd",Compression2))(Compression||{});function defaultDecompress(buf,compression){return __async(this,null,(function*(){if(1===compression||0===compression)return buf;if(2===compression){if(void 0===globalThis.DecompressionStream)return decompressSync(new Uint8Array(buf));{let result=new Response(buf).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(result).arrayBuffer()}}throw Error("Compression method not supported")}))}var TileType=(TileType2=>(TileType2[TileType2.Unknown=0]="Unknown",TileType2[TileType2.Mvt=1]="Mvt",TileType2[TileType2.Png=2]="Png",TileType2[TileType2.Jpeg=3]="Jpeg",TileType2[TileType2.Webp=4]="Webp",TileType2[TileType2.Avif=5]="Avif",TileType2))(TileType||{});function findTile(entries,tileId){let m=0,n=entries.length-1;for(;m<=n;){const k=n+m>>1,cmp=tileId-entries[k].tileId;if(cmp>0)m=k+1;else{if(!(cmp<0))return entries[k];n=k-1}}if(n>=0){if(0===entries[n].runLength)return entries[n];if(tileId-entries[n].tileId<entries[n].runLength)return entries[n]}return null}var FileAPISource=class{constructor(file){this.file=file}getKey(){return this.file.name}getBytes(offset,length){return __async(this,null,(function*(){const blob=this.file.slice(offset,offset+length);return{data:yield blob.arrayBuffer()}}))}},FetchSource=class{constructor(url,customHeaders=new Headers){this.url=url,this.customHeaders=customHeaders}getKey(){return this.url}setHeaders(customHeaders){this.customHeaders=customHeaders}getBytes(offset,length,signal){return __async(this,null,(function*(){let controller;signal||(controller=new AbortController,signal=controller.signal);const requestHeaders=new Headers(this.customHeaders);requestHeaders.set("Range","bytes="+offset+"-"+(offset+length-1));let resp=yield fetch(this.url,{signal:signal,headers:requestHeaders});if(416===resp.status&&0===offset){const content_range=resp.headers.get("Content-Range");if(!content_range||!content_range.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const actual_length=+content_range.substr(8);resp=yield fetch(this.url,{signal:signal,headers:{Range:"bytes=0-"+(actual_length-1)}})}if(resp.status>=300)throw Error("Bad response code: "+resp.status);const content_length=resp.headers.get("Content-Length");if(200===resp.status&&(!content_length||+content_length>length))throw controller&&controller.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield resp.arrayBuffer(),etag:resp.headers.get("ETag")||void 0,cacheControl:resp.headers.get("Cache-Control")||void 0,expires:resp.headers.get("Expires")||void 0}}))}};function getUint64(v,offset){const wh=v.getUint32(offset+4,!0),wl=v.getUint32(offset+0,!0);return wh*Math.pow(2,32)+wl}function bytesToHeader(bytes,etag){const v=new DataView(bytes),spec_version=v.getUint8(7);if(spec_version>3)throw Error(`Archive is spec version ${spec_version} but this library supports up to spec version 3`);return{specVersion:spec_version,rootDirectoryOffset:getUint64(v,8),rootDirectoryLength:getUint64(v,16),jsonMetadataOffset:getUint64(v,24),jsonMetadataLength:getUint64(v,32),leafDirectoryOffset:getUint64(v,40),leafDirectoryLength:getUint64(v,48),tileDataOffset:getUint64(v,56),tileDataLength:getUint64(v,64),numAddressedTiles:getUint64(v,72),numTileEntries:getUint64(v,80),numTileContents:getUint64(v,88),clustered:1===v.getUint8(96),internalCompression:v.getUint8(97),tileCompression:v.getUint8(98),tileType:v.getUint8(99),minZoom:v.getUint8(100),maxZoom:v.getUint8(101),minLon:v.getInt32(102,!0)/1e7,minLat:v.getInt32(106,!0)/1e7,maxLon:v.getInt32(110,!0)/1e7,maxLat:v.getInt32(114,!0)/1e7,centerZoom:v.getUint8(118),centerLon:v.getInt32(119,!0)/1e7,centerLat:v.getInt32(123,!0)/1e7,etag:etag}}function deserializeIndex(buffer){const p={buf:new Uint8Array(buffer),pos:0},numEntries=readVarint(p),entries=[];let lastId=0;for(let i=0;i<numEntries;i++){const v=readVarint(p);entries.push({tileId:lastId+v,offset:0,length:0,runLength:1}),lastId+=v}for(let i=0;i<numEntries;i++)entries[i].runLength=readVarint(p);for(let i=0;i<numEntries;i++)entries[i].length=readVarint(p);for(let i=0;i<numEntries;i++){const v=readVarint(p);entries[i].offset=0===v&&i>0?entries[i-1].offset+entries[i-1].length:v-1}return entries}var EtagMismatch=class extends Error{};function getHeaderAndRoot(source,decompress,prefetch,current_etag){return __async(this,null,(function*(){const resp=yield source.getBytes(0,16384);if(19792!==new DataView(resp.data).getUint16(0,!0))throw new Error("Wrong magic number for PMTiles archive");if(function(a){const v=new DataView(a);return 2===v.getUint16(2,!0)?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):1===v.getUint16(2,!0)?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}(resp.data)<3)return[yield v2_default.getHeader(source)];const headerData=resp.data.slice(0,127);let resp_etag=resp.etag;current_etag&&resp.etag!=current_etag&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+source.getKey()),resp_etag=void 0);const header=bytesToHeader(headerData,resp_etag);if(prefetch){const rootDirData=resp.data.slice(header.rootDirectoryOffset,header.rootDirectoryOffset+header.rootDirectoryLength),dirKey=source.getKey()+"|"+(header.etag||"")+"|"+header.rootDirectoryOffset+"|"+header.rootDirectoryLength,rootDir=deserializeIndex(yield decompress(rootDirData,header.internalCompression));return[header,[dirKey,rootDir.length,rootDir]]}return[header,void 0]}))}function getDirectory(source,decompress,offset,length,header){return __async(this,null,(function*(){const resp=yield source.getBytes(offset,length);if(header.etag&&header.etag!==resp.etag)throw new EtagMismatch(resp.etag);const directory=deserializeIndex(yield decompress(resp.data,header.internalCompression));if(0===directory.length)throw new Error("Empty directory is invalid");return directory}))}var mod,ResolvedValueCache=class{constructor(maxCacheEntries=100,prefetch=!0,decompress=defaultDecompress){this.cache=new Map,this.maxCacheEntries=maxCacheEntries,this.counter=1,this.prefetch=prefetch,this.decompress=decompress}getHeader(source,current_etag){return __async(this,null,(function*(){const cacheKey=source.getKey();if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return this.cache.get(cacheKey).data}const res=yield getHeaderAndRoot(source,this.decompress,this.prefetch,current_etag);return res[1]&&this.cache.set(res[1][0],{lastUsed:this.counter++,data:res[1][2]}),this.cache.set(cacheKey,{lastUsed:this.counter++,data:res[0]}),this.prune(),res[0]}))}getDirectory(source,offset,length,header){return __async(this,null,(function*(){const cacheKey=source.getKey()+"|"+(header.etag||"")+"|"+offset+"|"+length;if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return this.cache.get(cacheKey).data}const directory=yield getDirectory(source,this.decompress,offset,length,header);return this.cache.set(cacheKey,{lastUsed:this.counter++,data:directory}),this.prune(),directory}))}getArrayBuffer(source,offset,length,header){return __async(this,null,(function*(){const cacheKey=source.getKey()+"|"+(header.etag||"")+"|"+offset+"|"+length;if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return yield this.cache.get(cacheKey).data}const resp=yield source.getBytes(offset,length);if(header.etag&&header.etag!==resp.etag)throw new EtagMismatch(header.etag);return this.cache.set(cacheKey,{lastUsed:this.counter++,data:resp.data}),this.prune(),resp.data}))}prune(){if(this.cache.size>this.maxCacheEntries){let minKey,minUsed=1/0;this.cache.forEach(((cache_value,key)=>{cache_value.lastUsed<minUsed&&(minUsed=cache_value.lastUsed,minKey=key)})),minKey&&this.cache.delete(minKey)}}invalidate(source,current_etag){return __async(this,null,(function*(){this.cache.delete(source.getKey()),yield this.getHeader(source,current_etag)}))}},SharedPromiseCache=class{constructor(maxCacheEntries=100,prefetch=!0,decompress=defaultDecompress){this.cache=new Map,this.maxCacheEntries=maxCacheEntries,this.counter=1,this.prefetch=prefetch,this.decompress=decompress}getHeader(source,current_etag){return __async(this,null,(function*(){const cacheKey=source.getKey();if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return yield this.cache.get(cacheKey).data}const p=new Promise(((resolve,reject)=>{getHeaderAndRoot(source,this.decompress,this.prefetch,current_etag).then((res=>{res[1]&&this.cache.set(res[1][0],{lastUsed:this.counter++,data:Promise.resolve(res[1][2])}),resolve(res[0]),this.prune()})).catch((e=>{reject(e)}))}));return this.cache.set(cacheKey,{lastUsed:this.counter++,data:p}),p}))}getDirectory(source,offset,length,header){return __async(this,null,(function*(){const cacheKey=source.getKey()+"|"+(header.etag||"")+"|"+offset+"|"+length;if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return yield this.cache.get(cacheKey).data}const p=new Promise(((resolve,reject)=>{getDirectory(source,this.decompress,offset,length,header).then((directory=>{resolve(directory),this.prune()})).catch((e=>{reject(e)}))}));return this.cache.set(cacheKey,{lastUsed:this.counter++,data:p}),p}))}getArrayBuffer(source,offset,length,header){return __async(this,null,(function*(){const cacheKey=source.getKey()+"|"+(header.etag||"")+"|"+offset+"|"+length;if(this.cache.has(cacheKey)){this.cache.get(cacheKey).lastUsed=this.counter++;return yield this.cache.get(cacheKey).data}const p=new Promise(((resolve,reject)=>{source.getBytes(offset,length).then((resp=>{if(header.etag&&header.etag!==resp.etag)throw new EtagMismatch(resp.etag);resolve(resp.data),this.cache.has(cacheKey),this.prune()})).catch((e=>{reject(e)}))}));return this.cache.set(cacheKey,{lastUsed:this.counter++,data:p}),p}))}prune(){if(this.cache.size>=this.maxCacheEntries){let minKey,minUsed=1/0;this.cache.forEach(((cache_value,key)=>{cache_value.lastUsed<minUsed&&(minUsed=cache_value.lastUsed,minKey=key)})),minKey&&this.cache.delete(minKey)}}invalidate(source,current_etag){return __async(this,null,(function*(){this.cache.delete(source.getKey()),yield this.getHeader(source,current_etag)}))}},PMTiles=class{constructor(source,cache,decompress){this.source="string"==typeof source?new FetchSource(source):source,this.decompress=decompress||defaultDecompress,this.cache=cache||new SharedPromiseCache}getHeader(){return __async(this,null,(function*(){return yield this.cache.getHeader(this.source)}))}getZxyAttempt(z,x,y,signal){return __async(this,null,(function*(){const tile_id=zxyToTileId(z,x,y),header=yield this.cache.getHeader(this.source);if(header.specVersion<3)return v2_default.getZxy(header,this.source,this.cache,z,x,y,signal);if(z<header.minZoom||z>header.maxZoom)return;let d_o=header.rootDirectoryOffset,d_l=header.rootDirectoryLength;for(let depth=0;depth<=3;depth++){const entry=findTile(yield this.cache.getDirectory(this.source,d_o,d_l,header),tile_id);if(!entry)return;if(entry.runLength>0){const resp=yield this.source.getBytes(header.tileDataOffset+entry.offset,entry.length,signal);if(header.etag&&header.etag!==resp.etag)throw new EtagMismatch(resp.etag);return{data:yield this.decompress(resp.data,header.tileCompression),cacheControl:resp.cacheControl,expires:resp.expires}}d_o=header.leafDirectoryOffset+entry.offset,d_l=entry.length}throw Error("Maximum directory depth exceeded")}))}getZxy(z,x,y,signal){return __async(this,null,(function*(){try{return yield this.getZxyAttempt(z,x,y,signal)}catch(e){if(e instanceof EtagMismatch)return this.cache.invalidate(this.source,e.message),yield this.getZxyAttempt(z,x,y,signal);throw e}}))}getMetadataAttempt(){return __async(this,null,(function*(){const header=yield this.cache.getHeader(this.source),resp=yield this.source.getBytes(header.jsonMetadataOffset,header.jsonMetadataLength);if(header.etag&&header.etag!==resp.etag)throw new EtagMismatch(resp.etag);const decompressed=yield this.decompress(resp.data,header.internalCompression),dec=new TextDecoder("utf-8");return JSON.parse(dec.decode(decompressed))}))}getMetadata(){return __async(this,null,(function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof EtagMismatch)return this.cache.invalidate(this.source,e.message),yield this.getMetadataAttempt();throw e}}))}};return mod=js_exports,((to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key of __getOwnPropNames(from))__hasOwnProp.call(to,key)||key===except||__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to})(__defProp({},"__esModule",{value:!0}),mod)})();